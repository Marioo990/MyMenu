rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Funkcja pomocnicza: Czy user jest adminem?
    function isAdmin() {
      return request.auth != null &&
        // Sprawdź czy istnieje wpis w kolekcji admins (email lub UID)
        (exists(/databases/$(database)/documents/admins/$(request.auth.token.email)) ||
         exists(/databases/$(database)/documents/admins/$(request.auth.uid)));
    }

    // --- SAAS RULES ---

    // 1. Menu Items & Categories
    // PUBLIC: Dozwolony odczyt dla wszystkich (nawet bez logowania)
    // ADMIN: Pełny zapis
    match /menuItems/{document} {
      allow read: if true; // Publiczne czytanie (aplikacja filtruje po restaurantId)
      allow write: if isAdmin();
    }

    match /categories/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /dayPeriods/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 2. Restauracje i Ustawienia
    // Główny dokument restauracji
    match /restaurants/{restaurantId} {
      allow read: if true; // Publiczne (potrzebne do sprawdzenia nazwy/logo przy ładowaniu)
      allow write: if isAdmin(); // Tylko admin może tworzyć/edytować restaurację

      // Subkolekcja settings
      match /settings/{document} {
        allow read: if true;
        allow write: if isAdmin();
      }
    }

    // 3. Dane użytkowników (Prywatne)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // 4. Administratorzy (Tylko do odczytu dla adminów, żeby sprawdzić uprawnienia)
    match /admins/{document} {
      allow read: if request.auth != null; // Zalogowani mogą sprawdzić czy są adminami
      allow write: if false; // Admini są dodawani ręcznie w konsoli Firebase (bezpieczeństwo)
    }

    // 5. Powiadomienia
    match /notifications/{document} {
       allow read: if true;
       allow write: if isAdmin();
    }
  }
}